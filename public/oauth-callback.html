<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>OAuth Callback</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background: #f5f5f5;
      }
      .container {
        text-align: center;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      p {
        color: #666;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <p>Processing authentication...</p>
    </div>

    <script>
      window.onload = () => {
        // For hybrid flow (code id_token), Google returns BOTH in the hash fragment
        const paramsHash = new URLSearchParams(window.location.hash.slice(1));
        const id_token = paramsHash.get("id_token");
        const code = paramsHash.get("code"); // Code is also in hash for hybrid flow
        const stateHash = paramsHash.get("state");
        const errorHash = paramsHash.get("error");

        // Also check query string as fallback (for pure code flow)
        const params = new URLSearchParams(window.location.search);
        const codeQuery = params.get("code");
        const stateQuery = params.get("state");
        const errorQuery = params.get("error");

        // Use code from hash if available, otherwise from query
        const finalCode = code || codeQuery;
        const finalState = stateHash || stateQuery;
        const finalError = errorHash || errorQuery;

        if (!window.opener) {
          console.error("No opener window found");
          document.querySelector("p").textContent =
            "Error: No parent window found. Please close this window and try again.";
          return;
        }

        if (finalError) {
          // OAuth error
          window.opener.postMessage(
            {
              type: "oauth_error",
              error: finalError,
            },
            window.location.origin,
          );
          setTimeout(() => window.close(), 100);
        } else if (id_token || finalCode) {
          // Hybrid flow - send both id_token and code if available
          window.opener.postMessage(
            {
              type: "oauth_success",
              id_token: id_token,
              code: finalCode,
              state: finalState,
            },
            window.location.origin,
          );
          setTimeout(() => window.close(), 100);
        } else {
          // No token or code found
          console.error("No token or code found in URL");
          console.error("Hash:", window.location.hash);
          console.error("Search:", window.location.search);
          window.opener.postMessage(
            {
              type: "oauth_error",
              error: "No authorization token received",
            },
            window.location.origin,
          );
          setTimeout(() => window.close(), 100);
        }
      };
    </script>
  </body>
</html>
